<!--Matt Hay ~ Web ~ 11/16/21-->
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width"> <!--, initial-scale=1, shrink-to-fit=no-->
        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <link rel="stylesheet" href="/static/styles/gameScreen.css">
        <script src="{{url_for('static', filename='gameScreen.js')}}"></script>
        <script src="https://unpkg.com/konva@8.3.0/konva.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.min.js"></script>
        <!--<title> In-Game: {{game.name}} </title>-->
    </head>
    <header>
        <nav class="navbar navbar-expand-sm navbar-light bg-light">
          <div class="container-fluid">
            <a class="navbar-brand" style="font-weight:bold"> Game: {{game.name}} </a>
          </div>
          <div class="d-flex">
            <a href="{{url_for('home')}}">
            <button class="btn btn-outline-success my-2 my-sm-0" type="submit"> Home </button>
            </a>
            <a href="{{url_for('viewCharacters')}}">
            <button class="btn btn-outline-success my-2 my-sm-0 mx-2" type="submit"> Characters </button>
            </a>
          </div>
        </nav>

        <div id="username" class="{{user}}" style="display:none;"></div>
      </header>
    <body style="overflow: hidden;">
        <div class="d-flex w-100">
        <div id="Sidebar" class="w-25 border">
          <!--Sidebar header-->
          <div id="sidebarHead" class="d-flex justify-content-center"> <!--d-flex align-items-center flex-shrink-0 p-2 link-dark text-decoration-none border-bottom-->
            <button id="openChat-btn" class="tabButton"> Game Feed </button>
            <button id="openCharEdit-btn" class="tabButton"> Character </button>
          </div>
          <!--LIVE CHAT CONTAINER-->
          <div id="livechat" style="min-height: 29rem; max-height: 29rem">
            <!--LIST DIV-->
            <div id="msg-feed" class="panel-body border m-2 scrollarea" 
              style="overflow-y: scroll !important; height:250px !important; overflow-x: hidden;">
                <!--LIST ITEMS GO HERE-->
                <div class="left clearfix border-bottom my-1">
                  <p class="mx-2" style="color:MediumSeaGreen; word-break: break-all;"> Your Adventure Awaits! </p>
                </div>
            </div>

            <div class="input-actions">
              <form role="form">
                <div class="form-group m-2">
                  <textarea id="msg-box" class="form-control " style="resize:none; height:45px;" 
                    placeholder="Enter message..."></textarea>
                </div>
                <div class="form-group m-2">
                  <button id="sendMsg-btn" type="button" class="btn border"> Send </button>
                </div>
              </form>


              <button id="roll-D6" class="btn btn-outline-success m-2" > Roll D6 </button>
              <button id="roll-D10" class="btn btn-outline-success m-2" > Roll D10 </button>
              <button id="roll-D20" class="btn btn-outline-success m-2" > Roll D20 </button>
              <button id="showHideGreen"  class="btn btn-outline-success m-2" > Show/Hide Green </button>
              <button id="showHideYellow"  class="btn btn-outline-success m-2" > Show/Hide Yellow </button>
              <button id="showHideBlue"  class="btn btn-outline-success m-2" > Show/Hide Blue </button>
              <button id="showHideRed"  class="btn btn-outline-success m-2" > Show/Hide Red </button>
              <button id="showHideEnemyGreen"  class="btn btn-outline-success m-2" > Show/Hide Enemy Green </button>
              <button id="showHideEnemyYellow"  class="btn btn-outline-success m-2" > Show/Hide Enemy Yellow </button>
              <button id="showHideEnemyBlue"  class="btn btn-outline-success m-2" > Show/Hide Enemy Blue </button>
              <button id="showHideEnemyRed"  class="btn btn-outline-success m-2" > Show/Hide Enemy Red </button>
            </div>
          </div>
          <!--CHARACTER CONTAINER  hidden on default-->
          <div id="characterEditor" style="overflow-y: scroll !important; height:29.5rem !important; display: none;" align="center"> <!-- style="display: none; min-height: 29.5rem; max-height: 29.5rem" align="center"-->
            <form action="/action_page.php">
              <h4 class="d-flex justify-content-center m-2 p-1"> Name </h4>
              <label for="health">Health:</label>
              <input type="number" id="health" name="health" class="inputBox"><br><br>
              <label for="level">Level:</label>
              <input type="number" id="level" name="level" class="inputBox"><br><br>
              <label for="strength">Strength:</label>
              <input type="number" id="strength" name="strength" class="inputBox"><br><br>
              <label for="dexterity">Dexterity:</label>
              <input type="number" id="dexterity" name="dexterity" class="inputBox"><br><br>
              <label for="constitution">Constitution:</label>
              <input type="number" id="constitution" name="constitution" class="inputBox"><br><br>
              <label for="intelligence">Intelligence:</label>
              <input type="number" id="intelligence" name="intelligence" maxlength="2" class="inputBox"><br><br>
              <label for="wisdom">Wisdom:</label>
              <input type="number" id="wisdom" name="wisdom" class="inputBox"><br><br>
              <label for="charisma">Charisma:</label>
              <input type="number" id="charisma" name="charisma" class="inputBox"><br><br>
              <input type="submit" value="Save">
            </form>
          </div>
        </div>

        <!-- Game Board -->
        <div id="GameBoard" class="w-75 border"></div>
      </div>


      <!-- *****************************
        ********************************
        ******************************** -->
        {% if 1==1 %}
      <script>
// {"attrs":{"width":958,"height":800},"className":"Stage","children":[{"attrs":{},"className":"Layer","children":[{"attrs":{"width":958,"height":783,"id":"BM"},"className":"Rect"},{"attrs":{"id":"greenBox","x":379,"y":386,"width":50,"height":50,"fill":"green","draggable":true,"stroke":"black"},"className":"Rect"},{"attrs":{"id":"redBox","x":450,"y":375,"width":50,"height":50,"fill":"red","draggable":true,"stroke":"black","visible":false},"className":"Rect"},{"attrs":{"id":"blueBox","x":450,"y":375,"width":50,"height":50,"fill":"blue","stroke":"black","draggable":true,"visible":false},"className":"Rect"},{"attrs":{"id":"yellowBox","x":450,"y":375,"width":50,"height":50,"fill":"yellow","stroke":"black","draggable":true,"visible":false},"className":"Rect"},{"attrs":{"id":"pinkBox","x":450,"y":375,"width":50,"height":50,"fill":"pink","stroke":"black","draggable":true,"visible":false},"className":"Rect"},{"attrs":{"id":"purpleBox","x":450,"y":375,"width":50,"height":50,"fill":"purple","stroke":"black","draggable":true,"visible":false},"className":"Rect"},{"attrs":{"id":"blackBox","x":450,"y":375,"width":50,"height":50,"fill":"black","stroke":"white","draggable":true,"visible":false},"className":"Rect"},{"attrs":{"id":"brownBox","x":450,"y":375,"width":50,"height":50,"fill":"brown","stroke":"black","draggable":true,"visible":false},"className":"Rect"},{"attrs":{"id":"tr"},"className":"Transformer"}]}]}      
    var height = 800;
    var width = 1000;

    
    var stage = new Konva.Stage({
        container: 'GameBoard',
        width: width,
        height: height,
      });

      var layer = new Konva.Layer();
      stage.add(layer);

      
      fetch('/api/getboard/1/')
        .then(response => response.json())
        .then(data => {
          console.log(data);
          // TODO: This is where to fix the required reload (edit data json)
          layer.destroyChildren();
          stage = Konva.Node.create(data, 'GameBoard');

          var imageObj = new Image();
          imageObj.onload = function () {
            stage.findOne('#BM').fillPatternImage(imageObj);
          };
          imageObj.src = '/static/battle_map2.jpg';

          width = imageObj.naturalWidth;
          height = imageObj.naturalHeight;

          stage.findOne('#BM').moveToBottom();

          // Add box to trans
          stage.findOne('#greenBox').on('click', function() {
            stage.findOne('#tr').nodes([this])
          });

          stage.findOne('#BM').on('click', function() {
            stage.findOne('#tr').nodes([])
          });

          document.getElementById('showHideGreen').addEventListener('click', function () {
            if(stage.findOne('#greenBox').visible()) {
              stage.findOne('#greenBox').visible(false);
            }
            else {
              stage.findOne('#greenBox').visible(true);
            }
          });
          document.getElementById('showHideYellow').addEventListener('click', function () {
            if(stage.findOne('#yellowBox').visible()) {
              stage.findOne('#yellowBox').visible(false);
            }
            else {
              stage.findOne('#yellowBox').visible(true);
            }
          });

          stage.findOne('#greenBox').on('dragmove', function() {
            const absPos = this.getAbsolutePosition();
            // where are shapes inside bounding box of all shapes?
            const offsetX = this.x() - absPos.x;
            const offsetY = this.y() - absPos.y;

            // we total box goes outside of viewport, we need to move absolute position of shape
            const newAbsPos = { ...absPos };
            if (this.x() < 0) {
              newAbsPos.x = -offsetX;
            }
            if (this.y() < 0) {
              newAbsPos.y = -offsetY;
            }
            if (this.x() + this.width() > stage.width()) {
              newAbsPos.x = stage.width() - this.width() - offsetX;
            }
            if (this.y() + this.height() > stage.height()) {
              newAbsPos.y = stage.height() - this.height() - offsetY;
            }
            this.setAbsolutePosition(newAbsPos);
        });
      });
      
      
        
      
      /*
      var stage = new Konva.Stage({
        container: 'GameBoard',
        width: width,
        height: height,
      });

      var layer = new Konva.Layer();
      var rectX = stage.width() / 2 - 50;
      var rectY = stage.height() / 2 - 25;

      function createShape(){
        return new Konva.Rect({
          id: 'greenBox',
          x: rectX,
          y: rectY,
          width: 50,
          height: 50,
          fill: 'green',
          draggable: true,
          stroke: 'black',
          strokeWidth: 2,
          visible: true
        });
      }
      
      layer.add(createShape());

      var rect2 = new Konva.Rect({
        id: 'redBox',
        x: rectX,
        y: rectY,
        width: 50,
        height: 50,
        fill: 'red',
        draggable: true,
        stroke: 'black',
        strokeWidth: 2,
        visible: false
      });
      layer.add(rect2);

      var rect3 = new Konva.Rect({
        id: 'blueBox',
        x: rectX,
        y: rectY,
        width: 50,
        height: 50,
        fill: 'blue',
        stroke: 'black',
        strokeWidth: 2,
        draggable: true,
        visible: false
      });
      layer.add(rect3);

      var rect4 = new Konva.Rect({
        id: 'yellowBox',
        x: rectX,
        y: rectY,
        width: 50,
        height: 50,
        fill: 'yellow',
        stroke: 'black',
        strokeWidth: 2,
        draggable: true,
        visible: false
      });
      layer.add(rect4);

      var rect5 = new Konva.Rect({
        id: 'pinkBox',
        x: rectX,
        y: rectY,
        width: 50,
        height: 50,
        fill: 'pink',
        stroke: 'black',
        strokeWidth: 2,
        draggable: true,
        visible: false
      });
      layer.add(rect5);

      var rect6 = new Konva.Rect({
        id: 'purpleBox',
        x: rectX,
        y: rectY,
        width: 50,
        height: 50,
        fill: 'purple',
        stroke: 'black',
        strokeWidth: 2,
        draggable: true,
        visible: false
      });
      layer.add(rect6);

      var rect7 = new Konva.Rect({
        id: 'blackBox',
        x: rectX,
        y: rectY,
        width: 50,
        height: 50,
        fill: 'black',
        stroke: 'white',
        strokeWidth: 2,
        draggable: true,
        visible: false
      });
      layer.add(rect7);

      var rect8 = new Konva.Rect({
        id: 'brownBox',
        x: rectX,
        y: rectY,
        width: 50,
        height: 50,
        fill: 'brown',
        stroke: 'black',
        strokeWidth: 2,
        draggable: true,
        visible: false
      });
      layer.add(rect8);
      
      var imageObj = new Image();
      imageObj.onload = function () {
        var map = new Konva.Rect({
          x: 0,
          y: 0,
          image: imageObj,
          width: imageObj.naturalWidth,
          height: imageObj.naturalHeight,
          fillPatternImage: imageObj,
          id: 'BM'
        });
        // add the shape to the layer
        layer.add(map);
        map.moveToBottom()
      };
      imageObj.src = '/static/battle_map.jpg';

      width = imageObj.naturalWidth;

      const tr = new Konva.Transformer({
        id: "tr",
        nodes: [],
        boundBoxFunc: (oldBox, newBox) => {
          const box = getClientRect(newBox);
          const isOut =
            box.x < 0 ||
            box.y < 0 ||
            box.x + box.width > stage.width() ||
            box.y + box.height > stage.height();
          if (isOut) {
            return oldBox;
          }
          return newBox;
        },
      });
      layer.add(tr)
      stage.add(layer);
      */
      
      


      async function postData(url = '', data = {}) {
      // Default options are marked with *
      const response = await fetch(url, {
        method: 'POST',
        cache: 'no-cache',
        headers: {
          'Content-Type': 'application/json'
        },
        referrerPolicy: 'no-referrer', 
        body: JSON.stringify(data) 
      });
      return await response.json(); // parses JSON response into native JavaScript objects
      }

      const interval = setInterval(function() {
        var myObj = JSON.parse(stage.toJSON());
        myObj.attrs.height = height;
        myObj.attrs.width = width;

        postData('/api/addboard/1/', JSON.stringify(myObj))
          .then(data => {
            console.log("Posted to the server"); // JSON data parsed by `data.json()` call
          });
      }, 1000);


    </script>

    {% else %}
    <script>
      var height = 800;
      var width = 1000;

    
      var stage = new Konva.Stage({
        container: 'GameBoard',
        width: width,
        height: height,
      });

      var layer = new Konva.Layer();
      stage.add(layer);

      const interval = setInterval(function() {
      fetch('/api/getboard/1/')
        .then(response => response.json())
        .then(data => {
          console.log(data);
          // TODO: This is where to fix the required reload (edit data json)
          layer.destroyChildren();
          stage = Konva.Node.create(data, 'GameBoard');

          var imageObj = new Image();
          imageObj.onload = function () {
            stage.findOne('#BM').fillPatternImage(imageObj);
          };
          imageObj.src = '/static/battle_map.jpg';
        });
      }, 5000);
    </script>
    {% endif %}
        
    </body>
</html>